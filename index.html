<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D é¢éƒ¨æ•æ‰ Web æ¼”ç¤º</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="preconnect" href="https://cubism.live2d.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preload" href="models/kei_en/kei_vowels_pro/runtime/kei_vowels_pro.model3.json" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/kei_en/kei_vowels_pro/runtime/kei_vowels_pro.moc3" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/kei_en/kei_vowels_pro/runtime/kei_vowels_pro.2048/texture_00.png" as="image">
    <link rel="preload" href="models/å°æµ·è±¹è¯•ç”¨ç‰ˆ/è¯•ç”¨ç‰ˆ(æ°´å°ä¸å¯å»é™¤).model3.json" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/å°æµ·è±¹è¯•ç”¨ç‰ˆ/è¯•ç”¨ç‰ˆ(æ°´å°ä¸å¯å»é™¤).moc3" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/å°æµ·è±¹è¯•ç”¨ç‰ˆ/è¯•ç”¨ç‰ˆ(æ°´å°ä¸å¯å»é™¤).8192/texture_00.png" as="image">
    <link rel="preload" href="models/å°æµ·è±¹è¯•ç”¨ç‰ˆ/è¯•ç”¨ç‰ˆ(æ°´å°ä¸å¯å»é™¤).8192/texture_01.png" as="image">
    <link rel="preload" href="models/è‰¾ç›/è‰¾ç›.model3.json" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/è‰¾ç›/è‰¾ç›.moc3" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/è‰¾ç›/è‰¾ç›.8192/texture_00.png" as="image">
    <style>
        body { margin: 0; overflow: hidden; background-color: #202020; font-family: sans-serif; }
        #canvas { width: 100vw; height: 100vh; display: block; }
        
        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            color: white;
            width: 260px; /* ç¨å¾®ç¼©å°å®½åº¦ */
            max-height: 90vh;
            overflow-y: auto;
        }

        /* å³ä¾§ç›‘æ§é¢æ¿ */
        #monitor-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            color: white;
            z-index: 100;
            display: none; /* åˆå§‹éšè—ï¼Œæ‘„åƒå¤´å¼€å¯åæ˜¾ç¤º */
            flex-direction: column;
            max-height: 90vh;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .panel-header {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .panel-header span {
            font-weight: bold;
            font-size: 14px;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        #monitor-panel.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        #monitor-content {
            padding: 10px;
            overflow-y: auto;
            transition: max-height 0.3s;
        }

        #monitor-panel.collapsed #monitor-content {
            display: none;
        }
        
        #video-preview {
            width: 100%;
            border-radius: 4px;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            background: #000;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #output-canvas {
            width: 100%;
            border-radius: 4px;
            transform: scaleX(-1);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2; /* åœ¨è§†é¢‘ä¹‹ä¸Š */
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
        }

        /* è§†é¢‘å®¹å™¨ï¼Œç”¨äºé‡å  video å’Œ canvas */
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 æ¯”ä¾‹ */
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer; /* æç¤ºå¯ç‚¹å‡» */
        }
        
        .video-container video, .video-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* è°ƒè¯•ä¿¡æ¯åŒºåŸŸ */
        #debug-container {
            margin-top: 10px;
            font-size: 11px; 
            font-family: monospace; 
            color: #0f0; 
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 4px;
        }

        input[type="text"] {
            width: 100%;
            padding: 5px;
            margin-bottom: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
        }
        
        button:hover { background: #0056b3; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .status { font-size: 12px; color: #aaa; margin-top: 5px; }
        #load-progress {
            margin-top: 6px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            display: none;
        }
        #load-progress-bar {
            height: 100%;
            width: 0%;
            background: #3aa0ff;
            transition: width 0.2s ease;
        }
        #load-progress-text {
            font-size: 11px;
            color: #bbb;
            margin-top: 4px;
            display: none;
        }

        /* æ”¾å¤§é¢„è§ˆæ ·å¼ */
        .video-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container.expanded video,
        .video-container.expanded canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* ä¿æŒé•œåƒ */
            transform: scaleX(-1);
        }
        
        /* æ”¾å¤§æ—¶è°ƒæ•´ canvas ä½ç½®ï¼Œä½¿å…¶ä¸ video é‡åˆ */
        .video-container.expanded canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            z-index: 10000;
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .video-container.expanded .close-btn {
            display: flex;
        }
    </style>

    <!-- æ ¸å¿ƒä¾èµ– -->
    <!-- Cubism Core (å¿…é¡»åœ¨ pixi-live2d-display ä¹‹å‰åŠ è½½) -->
    <script defer src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <!-- Cubism 2 Core -->
    <script defer src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    
    <!-- PixiJS -->
    <script defer src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.1/dist/browser/pixi.min.js"></script>
    
    <!-- Pixi-Live2D-Display (ä½¿ç”¨æœ€æ–°ç‰ˆ) -->
    <script defer src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
    
    <!-- JSZip (ç”¨äºè§£å‹æ¨¡å‹å‹ç¼©åŒ…) -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- MediaPipe Drawing Utils (ç”¨äºç»˜åˆ¶éª¨éª¼) -->
    <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <!-- Kalidokit (é¢éƒ¨è§£ç®—) -->
    <script defer src="https://cdn.jsdelivr.net/npm/kalidokit@1.1.5/dist/kalidokit.umd.js"></script>
    
    <!-- MediaPipe Holistic (æ›¿æ¢ Face Mesh ä»¥æ”¯æŒå…¨èº«) -->
    <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- PeerJS (ç”¨äºè¿œç¨‹è¿æ¥) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

    <div id="ui-layer">
        <h3 style="margin: 0; color: #3aa0ff;">ç½‘é¡µæ‘„åƒå¤´ Live2D é¢æ• (v1.34.1)</h3>
        
        <!-- ç½‘ç»œé“¾æ¥åŒºåŸŸ -->
        <div style="margin-bottom: 10px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">é€‰æ‹©æ¨¡å‹ / è¾“å…¥é“¾æ¥</label>
            <select id="preset-select" style="width:100%; padding:5px; margin-bottom:5px; background:#333; color:white; border:1px solid #555;">
                <option value="models/kei_en/kei_basic_free/runtime/kei_basic_free.model3.json">Kei Basic (æœ¬åœ°)</option>
                <option value="models/kei_en/kei_vowels_pro/runtime/kei_vowels_pro.model3.json" selected>Kei Vowels (æœ¬åœ°)</option>
                <option value="models/YMT2.0/YMT2.0.model3.json">YMT2.0 (æœ¬åœ°)</option>
                <option value="models/å°æµ·è±¹è¯•ç”¨ç‰ˆ/è¯•ç”¨ç‰ˆ(æ°´å°ä¸å¯å»é™¤).model3.json">å°æµ·è±¹ (æœ¬åœ°)</option>
                <option value="models/è‰¾ç›/è‰¾ç›.model3.json">è‰¾ç› (æœ¬åœ°)</option>
            </select>
            <input type="text" id="model-url" placeholder="è¾“å…¥ .model3.json é“¾æ¥" value="models/kei_en/kei_vowels_pro/runtime/kei_vowels_pro.model3.json">
            <button id="btn-load">ğŸŒ åŠ è½½æ¨¡å‹</button>
        </div>

        <hr style="border-color: #444;">

        <button id="btn-camera">ğŸ“· å¼€å¯æ‘„åƒå¤´</button>
        <button id="btn-refresh" style="background: #6c757d; margin-top: 5px;">ğŸ”„ å¼ºåˆ¶åˆ·æ–°ç¼“å­˜</button>
        <div class="status" id="status-text">å‡†å¤‡å°±ç»ª</div>
        <div id="load-progress"><div id="load-progress-bar"></div></div>
        <div id="load-progress-text"></div>
        
        <!-- è°ƒè¯•è®¾ç½®é¢æ¿ -->
        <div style="margin-top: 10px; background: #333; padding: 5px; border-radius: 4px; font-size: 12px;">
            <div style="margin-bottom: 5px; font-weight: bold; color: #ddd;">éª¨éª¼æ˜¾ç¤ºè®¾ç½®</div>
            <label style="margin-right: 10px; cursor: pointer;"><input type="checkbox" id="cb-face" checked> é¢éƒ¨</label>
            <label style="margin-right: 10px; cursor: pointer;"><input type="checkbox" id="cb-pose" checked> èº«ä½“</label>
            <label style="cursor: pointer;"><input type="checkbox" id="cb-hands" checked> æ‰‹éƒ¨</label>
        </div>

        <div style="margin-top: 10px; background: #333; padding: 5px; border-radius: 4px; font-size: 12px;">
            <div style="font-weight: bold; font-size: 13px; margin-bottom: 5px; color: #3aa0ff;">ğŸ“¡ è¿œç¨‹è¿æ¥ (æœ¬æœºä½œä¸ºæ˜¾ç¤ºç«¯)</div>
            <div style="margin-bottom: 5px;">
                <span style="color: #aaa;">æœ¬æœº ID:</span>
                <span id="peer-id-display" style="font-family: monospace; color: #fff; background: #555; padding: 2px 4px; border-radius: 3px; cursor: pointer; user-select: all;" title="ç‚¹å‡»å¤åˆ¶">æ­£åœ¨è·å–...</span>
            </div>
            <div id="remote-status" style="font-size: 11px; color: #ffaa00; margin-top: 3px;">ç­‰å¾…è¿æ¥...</div>
            <button id="btn-sender" style="margin-top: 6px; width: 100%; background: #2e9fff;">ğŸ“¤ æ‰“å¼€å‘é€ç«¯ (sender.html)</button>
        </div>
    </div>

    <!-- å³ä¾§ç›‘æ§é¢æ¿ (æ–°) -->
    <div id="monitor-panel">
        <div class="panel-header" id="monitor-header">
            <span>å®æ—¶ç›‘æ§ <span id="fps-display" style="font-size:12px; color:#0f0; margin-left:10px;">FPS: --</span></span>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div id="monitor-content">
            <div class="video-container" id="video-container">
                <button id="video-close-btn" class="close-btn" title="å…³é—­å…¨å±">Ã—</button>
                <video id="video-preview" playsinline webkit-playsinline></video>
                <canvas id="output-canvas"></canvas>
            </div>
            <div id="debug-container">ç­‰å¾…æ•°æ®...</div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <!-- æ¨¡å—åŒ–è„šæœ¬ -->
    <script src="js/live2d-controller.js"></script>
    <script src="js/camera-controller.js"></script>
    <script src="js/main.js"></script>

</body>
</html>
