<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live2D é¢æ• Web (v2.0.7)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#202020">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="preconnect" href="https://cubism.live2d.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- é”™è¯¯ç›‘æ§ (æ”¾åœ¨æœ€å‰) -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:10px;left:10px;right:10px;background:rgba(200,0,0,0.9);color:white;padding:10px;z-index:9999;font-size:12px;border-radius:4px;word-break:break-all;';
            toast.innerHTML = 'ã€é”™è¯¯ã€‘' + msg + '<br>ä½ç½®: ' + (url ? url.split('/').pop() : 'unknown') + ':' + line;
            document.body.appendChild(toast);
            console.error('Global Error:', error);
            return false;
        };
        // æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', function(event) {
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:50px;left:10px;right:10px;background:rgba(200,100,0,0.9);color:white;padding:10px;z-index:9999;font-size:12px;border-radius:4px;word-break:break-all;';
            toast.innerHTML = 'ã€Promiseé”™è¯¯ã€‘' + event.reason;
            document.body.appendChild(toast);
        });
    </script>

    <!-- é¢„åŠ è½½æ ¸å¿ƒèµ„æº -->
    <link rel="preload" href="models/å¸Œç½—/å¸Œç½—.model3.json" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/å¸Œç½—/å¸Œç½—.moc3" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="models/å¸Œç½—/å¸Œç½—.4096/texture_00.png" as="image">
    <link rel="preload" href="models/è‰¾ç›/è‰¾ç›.model3.json" as="fetch" crossorigin="anonymous">
    
    <style>
        :root {
            --bg-color: #202020;
            --panel-bg: rgba(30, 30, 30, 0.75);
            --panel-border: rgba(255, 255, 255, 0.1);
            --text-color: #eee;
            --accent-color: #3aa0ff;
            --accent-hover: #2980b9;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: var(--font-family);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s;
        }

        body.transparent {
            background-color: transparent !important;
        }
        
        /* æ£‹ç›˜æ ¼èƒŒæ™¯ï¼ˆç”¨äºé€æ˜æ¨¡å¼ä¸‹çš„è§†è§‰åé¦ˆï¼‰ */
        body.transparent::before {
            /* åœ¨OBSä¸­ï¼Œå¦‚æœæ˜¯é€æ˜èƒŒæ™¯ï¼Œè¿™ä¸ªä¼ªå…ƒç´ åº”è¯¥è¢«éšè—æˆ–è€…ç”¨æˆ·åº”è¯¥çŸ¥é“ */
            /* è¿™é‡Œæˆ‘ä»¬ä¸åšæ£‹ç›˜æ ¼ï¼Œç›´æ¥é€æ˜ï¼Œæ–¹ä¾¿OBSã€‚å¦‚æœç”¨æˆ·éœ€è¦çœ‹è¾¹ç•Œï¼Œå¯ä»¥åˆ‡å›ç°è‰² */
            content: none;
        }

        #canvas {
            width: 100vw;
            height: 100vh;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        /* UI å®¹å™¨ */
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°æ¨¡å‹ */
            z-index: 100;
            transition: opacity 0.3s;
        }

        #ui-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 100vh;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid var(--panel-border);
            display: flex;
            flex-direction: column;
            pointer-events: auto;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* æ§ä»¶ç»„ */
        .control-group {
            margin-bottom: 25px;
        }

        .control-group-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        button, select, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 14px;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        button:hover, select:hover, input[type="text"]:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            outline: none;
        }

        button {
            cursor: pointer;
            font-weight: 500;
        }

        button.primary {
            background: var(--accent-color);
            color: white;
            border: none;
        }

        button.primary:hover {
            background: var(--accent-hover);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å¤é€‰æ¡†è¡Œ */
        .checkbox-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 15px;
            transition: background 0.2s;
        }
        
        .checkbox-label:hover {
            background: rgba(255,255,255,0.1);
        }

        .checkbox-label input {
            margin-right: 6px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-bar {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #555;
            margin-right: 6px;
        }
        .status-dot.active { background: var(--success-color); box-shadow: 0 0 5px var(--success-color); }
        .status-dot.error { background: var(--danger-color); }

        /* è¿›åº¦æ¡ */
        .progress-container {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.2s;
        }

        /* ç›‘æ§é¢æ¿ (å³ä¸Šè§’) */
        #monitor-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 240px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            overflow: hidden;
            pointer-events: auto;
            border: 1px solid var(--panel-border);
            display: none; /* åˆå§‹éšè— */
            flex-direction: column;
        }

        .monitor-header {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 */
            background: black;
        }

        .video-wrapper video, .video-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            object-fit: cover;
        }

        .video-wrapper canvas {
            z-index: 2;
        }
        
        #debug-info {
            padding: 10px;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 10px;
            color: #0f0;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
        }

        /* æ‚¬æµ®æŒ‰é’® (å·¦ä¸Šè§’ï¼Œç”¨äºåˆ‡æ¢ä¾§è¾¹æ ) */
        .float-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            pointer-events: auto;
            z-index: 200;
            backdrop-filter: blur(5px);
            transition: all 0.2s;
        }
        
        .float-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* éšè— UI æŒ‰é’® (å³ä¸‹è§’) */
        .hide-ui-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .hide-ui-btn:hover {
            background: rgba(0,0,0,0.6);
            color: white;
        }

        /* Toast æç¤º */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

    </style>
</head>
<body>

    <!-- æ ¸å¿ƒç”»å¸ƒ -->
    <canvas id="canvas"></canvas>

    <!-- æ‚¬æµ®æ§åˆ¶æŒ‰é’® -->
    <div class="float-btn" id="toggle-sidebar-btn" title="åˆ‡æ¢èœå•" style="top: 20px; left: 20px; z-index: 1001;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </div>

    <!-- UI å±‚ -->
    <div id="ui-container">
        
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header" style="padding-left: 70px;"> <!-- é¿å¼€å·¦ä¸Šè§’æŒ‰é’® -->
                <h1>Live2D é¢æ• <span style="font-size:12px; opacity:0.6; font-weight:normal;">v2.0.7</span></h1>
            </div>
            
            <div class="sidebar-content">
                
                <!-- æ¨¡å‹è®¾ç½® -->
                <div class="control-group">
                    <div class="control-group-title">æ¨¡å‹ç®¡ç†</div>
                    <select id="model-select">
                        <option value="" disabled>-- é€‰æ‹©æ¨¡å‹ --</option>
                        <option value="models/è‰¾ç›/è‰¾ç›.model3.json" selected>è‰¾ç› (é»˜è®¤)</option>
                        <option value="models/å¸Œç½—/å¸Œç½—.model3.json">å¸Œç½—</option>
                        <option value="models/kei_en/kei_vowels_pro/runtime/kei_vowels_pro.model3.json">Kei Vowels</option>
                        <option value="models/å°æµ·è±¹è¯•ç”¨ç‰ˆ/è¯•ç”¨ç‰ˆ(æ°´å°ä¸å¯å»é™¤).model3.json">å°æµ·è±¹</option>
                    </select>
                    
                    <div style="display: none;">
                        <input type="text" id="model-url" placeholder="URL (.model3.json)" style="margin-bottom:0;">
                        <button id="btn-load-url" style="width: auto; margin-bottom:0;">åŠ è½½</button>
                    </div>
                    
                    <div style="display: flex; gap: 5px;">
                        <button id="btn-load-selected" class="primary" style="margin-bottom:0;">åŠ è½½é€‰ä¸­æ¨¡å‹</button>
                    </div>
                    
                    <div class="progress-container" id="load-progress">
                        <div class="progress-bar" id="load-progress-bar"></div>
                    </div>
                </div>

                <!-- æ‘„åƒå¤´è®¾ç½® -->
                <div class="control-group">
                    <div class="control-group-title">é¢æ•è®¾ç½®</div>
                    <div style="display:flex; gap:5px;">
                        <button id="btn-camera" class="primary">ğŸ“· å¯åŠ¨</button>
                        <button id="btn-close-camera" style="background:#e74c3c; color:white;">ğŸš« å…³é—­</button>
                    </div>
                    
                    <div class="status-bar">
                        <div class="status-dot" id="status-dot"></div>
                        <span id="status-text">æ‘„åƒå¤´æœªå¯åŠ¨</span>
                    </div>

                    <div style="margin-top: 10px;">
                        <label style="font-size:12px; color:#aaa;">åˆ†è¾¨ç‡</label>
                        <select id="cam-resolution">
                            <option value="480x360">360p (æ€§èƒ½ä¼˜å…ˆ)</option>
                            <option value="640x480">480p (å‡è¡¡)</option>
                            <option value="1280x720" selected>720p (æ¨è)</option>
                            <option value="1920x1080">1080p (ç”»è´¨ä¼˜å…ˆ)</option>
                        </select>
                    </div>

                    <div style="margin-top: 10px;">
                        <label style="font-size:12px; color:#aaa;">æ¨¡å‹ç²¾åº¦ (Complexity)</label>
                        <select id="cam-complexity">
                            <option value="0">Lite (æé€Ÿ)</option>
                            <option value="1" selected>Full (æ ‡å‡†)</option>
                            <option value="2">Heavy (é«˜ç²¾)</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size:12px; color:#aaa;">FPS é™åˆ¶</label>
                            <select id="cam-fps-limit">
                                <option value="0">ä¸é™</option>
                                <option value="30">30 FPS</option>
                                <option value="60">60 FPS</option>
                            </select>
                        </div>
                    </div>

                    <div class="checkbox-row" style="margin-top: 10px;">
                        <label class="checkbox-label"><input type="checkbox" id="cam-refine" checked>ç²¾ç»†é¢éƒ¨</label>
                        <label class="checkbox-label"><input type="checkbox" id="cb-face" checked>é¢éƒ¨è¿½è¸ª</label>
                        <label class="checkbox-label"><input type="checkbox" id="cb-pose" checked>èº«ä½“è¿½è¸ª</label>
                        <label class="checkbox-label"><input type="checkbox" id="cb-hands" checked>æ‰‹åŠ¿è¿½è¸ª</label>
                    </div>
                </div>

                <!-- åœºæ™¯è®¾ç½® -->
                <div class="control-group">
                    <div class="control-group-title">åœºæ™¯ & ç³»ç»Ÿ</div>
                    <button id="btn-bg-transparent">ğŸ”³ åˆ‡æ¢é€æ˜èƒŒæ™¯ (OBS)</button>
                    <button id="btn-sender">ğŸ“¡ è¿œç¨‹å‘é€ç«¯ (æœ¬æœºæ˜¾ç¤º)</button>
                    <div style="margin-top:5px; font-size:12px; color:#aaa;">æœ¬æœº Peer ID: <span id="peer-id-display" style="user-select:all; color:white;">...</span></div>
                </div>

                <!-- åº•éƒ¨ -->
                <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--panel-border);">
                    <button id="btn-refresh" style="background: #e74c3c;">ğŸ”„ é‡ç½®ç¼“å­˜å¹¶åˆ·æ–°</button>
                </div>

            </div>
        </div>

        <!-- ç›‘æ§é¢æ¿ -->
        <div id="monitor-panel">
            <div class="monitor-header" id="monitor-toggle">
                <span>é¢„è§ˆ <span id="fps-display" style="color:#0f0;">--</span> FPS</span>
                <span>â–¼</span>
            </div>
            <div id="monitor-content">
                <div class="video-wrapper">
                    <video id="video-preview" playsinline webkit-playsinline></video>
                    <canvas id="output-canvas"></canvas>
                </div>
                <div id="debug-info">ç­‰å¾…æ•°æ®...</div>
            </div>
        </div>

        <!-- å…¨å±€éšè—æŒ‰é’® -->
        <div class="hide-ui-btn" id="hide-ui-btn">ğŸ‘ï¸ éšè— UI</div>

    </div>

    <!-- Toast -->
    <div id="toast">æç¤ºä¿¡æ¯</div>

    <!-- ä¾èµ–åº“ -->
    <script defer src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.1/dist/browser/pixi.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/kalidokit@1.1.5/dist/kalidokit.umd.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- ä¸šåŠ¡é€»è¾‘ -->
    <script defer src="js/live2d-controller.js"></script>
    <script defer src="js/camera-controller.js"></script>
    <script defer src="js/main.js"></script>
    <script src="sw.js"></script>

    <script>
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('SW Registered'))
                .catch(err => console.error('SW Error:', err));
        }
    </script>
</body>
</html>