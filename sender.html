<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D é¢æ• - é‡‡é›†ç«¯ (Sender)</title>
    <style>
        body { 
            background: #202020; 
            color: white; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }
        h2 { margin-top: 0; }
        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .status-box {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #444;
            color: white;
            width: 70%;
            text-align: center;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            background: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled { background: #555; }
        
        #video-container {
            position: relative;
            width: 100%;
            margin-top: 10px;
        }
        #video-preview {
            width: 100%;
            border-radius: 8px;
            transform: scaleX(-1);
            background: black;
            display: block;
        }
        #output-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            pointer-events: none;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }
        select {
            padding: 8px;
            background: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
        }
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            margin-top: 10px;
            height: 100px;
            overflow-y: auto;
            background: #111;
            padding: 5px;
            border-radius: 4px;
            text-align: left;
        }
    </style>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- MediaPipe & Kalidokit (ä¸ä¸»é¡µä¸€è‡´) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kalidokit@1.1.5/dist/kalidokit.umd.js"></script>
</head>
<body>

    <div class="container">
        <div class="status-box">
            <h2>ğŸ“± é‡‡é›†ç«¯</h2>
            <button onclick="window.location.href='index.html'" style="margin-bottom:15px; background:#444; font-size:12px; padding:5px 10px;">ğŸ”™ è¿”å›ç”µè„‘ç‰ˆ (æ˜¾ç¤ºç«¯)</button>
            <p>1. åœ¨ç”µè„‘ç«¯ç‚¹å‡» "ç”Ÿæˆè¿æ¥ç "</p>
            <p>2. åœ¨ä¸‹æ–¹è¾“å…¥ç”µè„‘ç«¯çš„è¿æ¥ç </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <input type="text" id="target-id" placeholder="è¾“å…¥ç”µè„‘ç«¯ ID (ä¾‹å¦‚: PC-1234)">
                <button id="btn-connect">è¿æ¥</button>
            </div>
            <div id="connection-status" style="margin-top: 10px; color: #ffaa00;">æœªè¿æ¥</div>
        </div>

        <div class="controls" id="camera-controls" style="display:none;">
            <select id="sel-resolution">
                <option value="480x360">360p (æµç•…)</option>
                <option value="640x480" selected>480p (é»˜è®¤)</option>
                <option value="1280x720">720p (é«˜æ¸…)</option>
            </select>
            <select id="sel-model">
                <option value="0">Lite (æé€Ÿ)</option>
                <option value="1" selected>Full (å‡è¡¡)</option>
                <option value="2">Heavy (ç²¾å‡†)</option>
            </select>
            <button id="btn-restart-cam" style="padding: 5px 10px; font-size: 14px;">åº”ç”¨è®¾ç½®</button>
        </div>

        <div id="video-container">
            <video id="video-preview" playsinline></video>
            <canvas id="output-canvas"></canvas>
        </div>
        
        <div class="log" id="log-area"></div>
    </div>

    <script>
        const logArea = document.getElementById('log-area');
        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logArea.prepend(div);
        }

        // 1. åˆå§‹åŒ– PeerJS
        const peer = new Peer(null, {
            debug: 2,
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' },
                    { url: 'stun:stun2.l.google.com:19302' },
                    { url: 'stun:stun3.l.google.com:19302' }
                ]
            }
        });
        
        let conn = null;
        let lastSendTime = 0;

        peer.on('open', (id) => {
            log('æœ¬æœº Peer ID: ' + id);
        });

        peer.on('error', (err) => {
            log('PeerJS é”™è¯¯: ' + err.type);
            document.getElementById('connection-status').innerText = "è¿æ¥é”™è¯¯";
        });

        // 2. è¿æ¥é€»è¾‘
        document.getElementById('btn-connect').addEventListener('click', () => {
            const targetId = document.getElementById('target-id').value.trim();
            if (!targetId) return alert('è¯·è¾“å…¥ç›®æ ‡ ID');
            
            log(`æ­£åœ¨è¿æ¥åˆ° ${targetId}...`);
            conn = peer.connect(targetId);

            conn.on('open', () => {
                log('è¿æ¥æˆåŠŸï¼å¼€å§‹ä¼ è¾“æ•°æ®...');
                document.getElementById('connection-status').innerText = "âœ… å·²è¿æ¥ - æ­£åœ¨ä¼ è¾“";
                document.getElementById('connection-status').style.color = "#0f0";
                startCamera();
            });

            conn.on('close', () => {
                log('è¿æ¥å·²æ–­å¼€');
                document.getElementById('connection-status').innerText = "âŒ è¿æ¥æ–­å¼€";
                document.getElementById('connection-status').style.color = "red";
            });
            
            conn.on('error', (err) => log('è¿æ¥é”™è¯¯: ' + err));
        });

        // 3. æ‘„åƒå¤´ä¸ MediaPipe é€»è¾‘
        let holistic = null;
        let camera = null;

        // é»˜è®¤é…ç½®
        let config = {
            width: 640,
            height: 480,
            complexity: 1
        };

        // ç»‘å®šè®¾ç½®æŒ‰é’®
        document.getElementById('btn-restart-cam').addEventListener('click', () => {
            const resVal = document.getElementById('sel-resolution').value;
            const modelVal = document.getElementById('sel-model').value;
            const [w, h] = resVal.split('x').map(Number);
            
            config.width = w;
            config.height = h;
            config.complexity = parseInt(modelVal);
            
            startCamera();
        });

        async function startCamera() {
            const videoElement = document.getElementById('video-preview');
            const canvasElement = document.getElementById('output-canvas');
            const canvasCtx = canvasElement.getContext('2d');
            
            // æ˜¾ç¤ºæ§åˆ¶æ¡
            document.getElementById('camera-controls').style.display = 'flex';

            if (camera) {
                // å°è¯•åœæ­¢æ—§æ‘„åƒå¤´ (CameraUtils æ²¡æœ‰ stopï¼Œåªèƒ½é‡æ–° new)
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥é‡æ–°åˆå§‹åŒ–
                log('é‡å¯æ‘„åƒå¤´...');
            } else {
                log('åˆå§‹åŒ–æ‘„åƒå¤´...');
            }

            // åˆå§‹åŒ– Holistic
            if (!holistic) {
                holistic = new Holistic({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
                }});
                holistic.onResults(onResults);
            }

            // æ›´æ–°é€‰é¡¹
            holistic.setOptions({
                modelComplexity: config.complexity,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5,
                refineFaceLandmarks: true
            });

            // åˆå§‹åŒ– Camera
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    await holistic.send({image: videoElement});
                },
                width: config.width,
                height: config.height
            });
            
            // è®¾ç½® canvas å°ºå¯¸
            canvasElement.width = config.width;
            canvasElement.height = config.height;

            camera.start();
        }

        function onResults(results) {
            // ç»˜åˆ¶éª¨éª¼
            const canvasElement = document.getElementById('output-canvas');
            const canvasCtx = canvasElement.getContext('2d');
            
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // ç»˜åˆ¶
            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 1, radius: 3});
            }
            if (results.faceLandmarks) {
                drawConnectors(canvasCtx, results.faceLandmarks, FACEMESH_TESSELATION, {color: '#C0C0C070', lineWidth: 1});
            }
            if (results.leftHandLandmarks) {
                drawConnectors(canvasCtx, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#CC0000', lineWidth: 2});
            }
            if (results.rightHandLandmarks) {
                drawConnectors(canvasCtx, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#00CC00', lineWidth: 2});
            }
            canvasCtx.restore();

            if (!conn || !conn.open) return;

            // é™åˆ¶å‘é€é¢‘ç‡ (ä¾‹å¦‚ 30 FPS)
            const now = Date.now();
            if (now - lastSendTime < 30) return; 
            lastSendTime = now;

            // ä½¿ç”¨ Kalidokit è§£ç®—
            const faceLandmarks = results.faceLandmarks;
            const poseLandmarks = results.poseLandmarks;
            const ea = results.faceLandmarks ? Kalidokit.Face.solve(faceLandmarks, {
                runtime: 'mediapipe',
                video: document.getElementById('video-preview')
            }) : null;

            const pose = results.poseLandmarks ? Kalidokit.Pose.solve(poseLandmarks, results.poseLandmarks, {
                runtime: 'mediapipe',
                video: document.getElementById('video-preview')
            }) : null;
            
            // ç®€å•çš„æ•°æ®åŒ…
            const dataPacket = {
                face: ea,
                pose: pose,
                // è¿™é‡Œåªå‘é€å¿…è¦çš„è§£ç®—åæ•°æ®ï¼Œä¸å‘é€åŸå§‹ Landmarks ä»¥èŠ‚çœå¸¦å®½
                timestamp: now
            };

            conn.send(dataPacket);
        }
    </script>
</body>
</html>